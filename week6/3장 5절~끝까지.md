# 3장 메모리 (5절~끝까지)


### 시스템 호출을 통한 메모리 할당 과정

- CPU 는 4가지 특권단계(0, 1, 2, 3)를 갖는다.
- 보통은 0과 3단계만 사용된다.
    - 커널 모드(0) : 시스템 호출 명령 사용 가능. 모든 주소 공간과 HW에 접근하고 기계 명령어 실행 가능
    - 사용자 모드(3) : 일반적인 코드 실행. 표준 라이브러리 사용하여 시스템 호출 사용
- 표준 라이브러리(standard library) : 여러 운영체제에서 시스템호출을 사용하기위해 저수준 계층의 차이를 감추는 표준
    - 프로세스는 사용자모드에서 표준 라이브러리를 통해 시스템 호출을 사용
    - CPU는 시스템 호출 실행 시 커널모드로 변경되어 시스템 호출 명령어를 실행함
    - e.g. malloc
- brk : 리눅스 시스템 호출 명령어. 메모리 부족 시 힙 영역 추가할당 요청
- segmentation fault : 허용되지 않은 메모리에 접근할 때 발생하는 오류
    - 사용자모드에 제한이 존재하지 않는다면 운영체제 영역에 침범해 이런 오류가 발생할 것

- 메모리 부족 시 할당 과정
    1. 코드 상에서 malloc 으로 메모리 할당
    2. malloc 실행 과정에서 여유 메모리 부족 → brk 시스템콜로 운영체제에 힙 확장 요청
    3. CPU 가 커널모드로 전환 후 시스템콜 실행
    4. 운영체제는 가상메모리 주소 반환 (실제 물리메모리 할당 여부 미지수)
    5. CPU 가 다시 사용자모드로 전환되고 프로그램 이어서 실행
    6. 해당 메모리가 실제로 사용되는 시점에 메모리 할당 전일 경우 페이지 누락 오류 page fault 발생
    7. page fault interrupt 로 CPU가 커널모드로 전환
    8. 운영체제가 오류 감지 후 물리 메모리 할당, mapping
    9. 사용자모드로 전환
    10. 프로세스는 오류 사실을 모름
    
    → malloc 은 가상메모리 2차할당에 불과
    
    → malloc 을 통한 빈번한 메모리 조작은 성능에 영향
    

### 메모리 풀

- 특정 상황에 최적화도록 자체적으로 만든 메모리 할당 전략
    - 응용프로그램 레벨에서 구현됨
    - 특정 상황에만 높은 성능. 범용성 x
- 운영체제로부터 한번에 큰 메모리 조각을 요청해두고, 자체적으로 메모리 할당과 해제 관리  
    
    → 표준 라이브러리와 운영체제 우회 (거치지 않음)
    
- 메모리 풀에 필요한 객체를 미리 생성해둠
- 요청 처리 동안에는 메모리 할당만 함  
    
    → 해제는 요청이 끝난 후에 하여 처리 부담 최소화
    
- 다중스레드 환경에서는 스레드 전용 저장소로 구현하여 성능과 안정성 모두 확보

### 대표적인 메모리 관련 버그

- 버그 종류
    - 지역변수의 포인터 반환
    - 포인터 연산 오류 - 배열 포인터 크기 증감 시 +1 이 한 항목 크기만큼의 이동 연산임
    - 잘못된 포인터 역참조 (e.g. scanf() 사용 시 주소값이 아닌 값을 주소로 사용)
    - 초기화하지 않고 메모리 읽기 - 다른 프로세스에서 사용했던 데이터가 남아있을 수 있음
    - 메모리 해제 후 참조
    - 배열 인덱스 접근 오류
    - 스택 오버플로우 - 할당한 공간보다 큰 데이터 입력받기
    - 메모리 누수 - 해제하지 않고 종료. 점점 프로세스가 차지하는 공간이 늘어나 운영체제에 의해 강제종료됨

- 이러한 버그를 찾기 위해 적절한 메모리 분석 도구를 사용해야 함
- 메모리 분석 도구 종류 크게 2가지
    - malloc 과 free 사용 상황 추적
    - page fault 시 메모리 누수가 의심되므로 이러한 시스템 이벤트 기록정보를 추적

### SSD와 메모리의 차이점(SSD를 메모리로 사용할 수 없는 이유)

- 메모리 속도가 10배 이상 빠름
- 주소 지정 단위의 차이
    - 메모리 : 바이트 단위 주소 사용
    - SSD : 할당할 디스크 조각 단위 주소 사용  
        → CPU가 직접 특정 바이트 주소에 접근할 수 없음
        
- 64비트 시스템은 문제가 없지만, 32비트 시스템의 경우 최대 주소 지정 범위 4GB
    
    4GB 이상의 메모리 사용할 수 없음
    
- SSD 는 읽고 쓰는 작업에 있어 사용 수명 제한이 있음
    
    CPU가 사용하기에는 수명이 너무 짧음
    
---
### 궁금한 점

- segmentation fault : 허용되지 않은 메모리에 접근하는 것
    - 사용자모드에서 운영체제를 종료하는 것?? 249p
- malloc 은 2차 할당? 256p
- 책에서 말하는 메모리 풀이
    
     코드상으로 구현된 해시맵 캐시 같은거 맞을까요?
    
- 264p 의 스레드 전용 저장소 사용 시 문제상황 예시가 무슨 말일까요,,
